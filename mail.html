<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Future Mail üì®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; touch-action: manipulation; }
        body, html {
            min-height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #e0e7ff 0%, #c084fc 100%);
            overflow-x: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 50;
            background: white; padding: 10px 24px; border-radius: 99px;
            color: #7c3aed; font-weight: bold; text-decoration: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .back-btn:active { transform: scale(0.95); }

        .container {
            width: 90%; max-width: 600px; margin-top: 80px; margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 30px; border-radius: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 { font-family: 'Pacifico', cursive; font-size: 2.5rem; color: #7c3aed; margin-bottom: 10px; }
        p { color: #6b7280; margin-bottom: 20px; font-size: 0.95rem; }

        /* --- SHARED DATE SECTION --- */
        .date-section {
            background: #f3f4f6; padding: 15px; border-radius: 15px; margin-bottom: 20px;
            border: 2px dashed #c4b5fd;
        }
        .date-display {
            font-weight: bold; color: #6d28d9; font-size: 1.1rem;
        }

        /* --- SLOTS --- */
        .slot {
            background: white; border: 2px solid #ddd6fe; border-radius: 15px;
            padding: 20px; margin-bottom: 20px; text-align: left;
            transition: all 0.3s;
        }
        .slot.locked {
            background: #f5f3ff; border-color: #8b5cf6; border-style: dashed;
            text-align: center;
        }
        .slot-header {
            font-weight: 700; color: #4c1d95; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }

        textarea {
            width: 100%; padding: 12px; border: 2px solid #ddd6fe;
            border-radius: 12px; outline: none; font-family: inherit;
            transition: border 0.3s; background: #fff; height: 120px; resize: none;
        }
        textarea:focus { border-color: #8b5cf6; }

        .btn-lock {
            background: #8b5cf6; color: white; border: none;
            padding: 12px; border-radius: 99px; width: 100%;
            font-weight: bold; cursor: pointer; margin-top: 10px;
            transition: transform 0.1s;
        }
        .btn-lock:active { transform: scale(0.98); }

        /* --- STATUS --- */
        .status-locked { color: #8b5cf6; font-style: italic; font-size: 0.9rem; }
        .status-unlocked { color: #4b5563; white-space: pre-wrap; line-height: 1.6; }
        .countdown { color: #db2777; font-weight: bold; margin-top: 5px; font-size: 0.9rem; }

        .hidden { display: none; }
        #loading { font-weight: bold; color: #7c3aed; margin-bottom: 10px; }

    </style>
</head>
<body>

    <a href="index.html" class="back-btn">üè† Home</a>

    <div class="container">
        <div id="loading">Menghubungkan ke awan... ‚òÅÔ∏è</div>

        <h1>Surat Masa Depan</h1>
        <p>Tulis pesan untuk masa depan. Pesan ini akan terkunci sampai tanggal yang kita tentukan! üï∞Ô∏è</p>

        <!-- SHARED DATE SETTING -->
        <div class="date-section" id="date-setup">
            <label class="block text-sm font-bold text-purple-700 mb-2">Pilih Tanggal Buka:</label>
            <input type="date" id="unlock-date" class="w-full p-2 rounded-lg border-2 border-purple-200">
        </div>
        
        <div class="date-section hidden" id="date-locked-display">
            <p class="text-sm text-gray-500">Akan terbuka pada:</p>
            <div class="date-display" id="target-date-text"></div>
            <div class="countdown" id="main-countdown"></div>
        </div>

        <!-- SLOT 1: DAINEL -->
        <div class="slot" id="slot-dainel">
            <div class="slot-header">
                <span>üë¶ Pesan Dainel</span>
                <span class="icon">üîì</span>
            </div>
            <div class="input-area">
                <textarea id="msg-dainel" placeholder="Tulis pesanmu di sini..."></textarea>
                <button class="btn-lock" onclick="lockMessage('dainel')">Kunci Pesan üîí</button>
            </div>
            <div class="locked-view hidden">
                <p class="status-locked">Pesan sudah dikunci dan tersimpan aman.</p>
            </div>
            <div class="revealed-view hidden">
                <p class="status-unlocked" id="read-dainel"></p>
            </div>
        </div>

        <!-- SLOT 2: PRINCESS -->
        <div class="slot" id="slot-princess">
            <div class="slot-header">
                <span>üëß Pesan Artika</span>
                <span class="icon">üîì</span>
            </div>
            <div class="input-area">
                <textarea id="msg-princess" placeholder="Tulis pesanmu di sini..."></textarea>
                <button class="btn-lock" onclick="lockMessage('artika')">Kunci Pesan üîí</button>
            </div>
            <div class="locked-view hidden">
                <p class="status-locked">Pesan sudah dikunci dan tersimpan aman.</p>
            </div>
            <div class="revealed-view hidden">
                <p class="status-unlocked" id="read-princess"></p>
            </div>
        </div>
        
        <!-- RESET BUTTON -->
         <button onclick="resetAll()" class="mt-8 text-xs text-red-400 underline opacity-50 hover:opacity-100">Reset Semua (Bahaya!)</button>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBr-t2wA_RyinYD1VH8v8egbK8j7PoD5L0",
          authDomain: "pumpkinmuffin-42e59.firebaseapp.com",
          projectId: "pumpkinmuffin-42e59",
          storageBucket: "pumpkinmuffin-42e59.firebasestorage.app",
          messagingSenderId: "263457826624",
          appId: "1:263457826624:web:eecfb112115cf94c5dfca5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "letters", "shared_future_mail");

        const loading = document.getElementById('loading');
        const dateInput = document.getElementById('unlock-date');
        const dateSetup = document.getElementById('date-setup');
        const dateDisplay = document.getElementById('date-locked-display');
        const targetText = document.getElementById('target-date-text');
        const countdown = document.getElementById('main-countdown');

        // Set min date
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        dateInput.min = tomorrow.toISOString().split('T')[0];

        // --- REALTIME SYNC ---
        onSnapshot(docRef, (docSnap) => {
            loading.classList.add('hidden');
            if (docSnap.exists()) {
                const data = docSnap.data();
                updateUI(data);
            } else {
                // New clean state
                dateSetup.classList.remove('hidden');
                dateDisplay.classList.add('hidden');
                resetSlotUI('dainel');
                resetSlotUI('princess');
            }
        });

        function updateUI(data) {
            const now = new Date();
            const target = new Date(data.unlockDate);
            target.setHours(0,0,0,0);
            now.setHours(0,0,0,0);

            // 1. Handle Date Display
            if (data.unlockDate) {
                dateSetup.classList.add('hidden');
                dateDisplay.classList.remove('hidden');
                
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                targetText.innerText = target.toLocaleDateString('id-ID', options);

                const diffDays = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                    countdown.innerText = `Masih ${diffDays} hari lagi!`;
                    countdown.classList.remove('text-green-600');
                    countdown.classList.add('text-pink-600');
                } else {
                    countdown.innerText = "HARI INI! SILAHKAN BACA üéâ";
                    countdown.classList.remove('text-pink-600');
                    countdown.classList.add('text-green-600');
                }
            }

            const isUnlocked = now >= target;

            // 2. Update Slots
            updateSlot('dainel', data.dainel, isUnlocked);
            updateSlot('princess', data.princess, isUnlocked);
        }

        function updateSlot(user, slotData, isUnlocked) {
            const slotEl = document.getElementById(`slot-${user}`);
            const inputArea = slotEl.querySelector('.input-area');
            const lockedView = slotEl.querySelector('.locked-view');
            const revealedView = slotEl.querySelector('.revealed-view');
            const readText = document.getElementById(`read-${user}`);
            const icon = slotEl.querySelector('.icon');

            if (slotData && slotData.locked) {
                // Content exists
                inputArea.classList.add('hidden');
                slotEl.classList.add('locked');
                
                if (isUnlocked) {
                    // SHOW CONTENT
                    lockedView.classList.add('hidden');
                    revealedView.classList.remove('hidden');
                    readText.innerText = slotData.message;
                    icon.innerText = "üíå";
                    slotEl.style.borderColor = "#22c55e"; // Green border
                    slotEl.style.backgroundColor = "#f0fdf4";
                } else {
                    // STILL LOCKED
                    lockedView.classList.remove('hidden');
                    revealedView.classList.add('hidden');
                    icon.innerText = "üîí";
                    slotEl.style.borderColor = "#8b5cf6"; // Purple border
                }
            } else {
                // Empty Slot
                resetSlotUI(user);
            }
        }

        function resetSlotUI(user) {
            const slotEl = document.getElementById(`slot-${user}`);
            slotEl.querySelector('.input-area').classList.remove('hidden');
            slotEl.querySelector('.locked-view').classList.add('hidden');
            slotEl.querySelector('.revealed-view').classList.add('hidden');
            slotEl.classList.remove('locked');
            slotEl.querySelector('.icon').innerText = "üîì";
            slotEl.style.borderColor = "#ddd6fe";
            slotEl.style.backgroundColor = "white";
        }

        // --- ACTIONS ---
        
        window.lockMessage = async function(user) {
            const msg = document.getElementById(`msg-${user}`).value.trim();
            const dateVal = dateInput.value;

            // Logic: First person sets the date. Second person must follow it.
            // If date is already set in UI (hidden input), use that? 
            // Actually simpler: Check if date is set in DB. If not, require input.
            
            // We can just check if the date section is visible
            if (!dateSetup.classList.contains('hidden') && !dateVal) {
                return alert("Tentukan tanggal bukanya dulu ya!");
            }
            
            if (!msg) return alert("Pesan gaboleh kosong!");

            const updateData = {};
            updateData[user] = {
                message: msg,
                locked: true,
                timestamp: new Date().toISOString()
            };

            // If setting date for first time
            if (!dateSetup.classList.contains('hidden')) {
                updateData.unlockDate = dateVal;
            }

            try {
                loading.classList.remove('hidden');
                // Use setDoc with merge to update or create
                await setDoc(docRef, updateData, { merge: true });
                location.reload();
            } catch (e) {
                console.error(e);
                alert("Gagal menyimpan. Cek koneksi internet.");
                loading.classList.add('hidden');
            }
        };

        window.resetAll = async function() {
            if(confirm("SERIUS? Ini bakal menghapus SEMUA pesan kalian berdua secara permanen!")) {
                await deleteDoc(docRef);
                location.reload();
            }
        };

    </script>
</body>
</html>